{{ 'section-cbv-builder-product.css' | asset_url | stylesheet_tag }}
<script src="{{ 'cbv-builder-product.js' | asset_url }}" defer="defer"></script>

{%- liquid
  assign product_form_id = 'cbv-builder-product-form-' | append: section.id
  assign current_variant = product.selected_or_first_available_variant
-%}

<section class="cbv-builder color-{{ section.settings.color_scheme }} gradient" data-cbv-builder data-section-id="{{ section.id }}">
  <div class="page-width section-{{ section.id }}-padding">
    
    <div class="cbv-builder__grid">
      
      <!-- Media Column -->
      <div class="cbv-builder__media">
        {% if product.featured_media %}
          <div class="cbv-builder__image-wrapper" style="--ratio-percent: {{ 1 | divided_by: product.featured_media.aspect_ratio | times: 100 }}%;">
            {{
              product.featured_media
              | image_url: width: 1200
              | image_tag:
                id: 'CBV-Main-Image',
                loading: 'lazy',
                widths: '400, 600, 900, 1200',
                sizes: '(min-width: 990px) 50vw, 100vw',
                class: 'cbv-builder__image'
            }}
          </div>
        {% endif %}
      </div>

      <!-- Content Column -->
      <div class="cbv-builder__content">
        <p class="cbv-builder__eyebrow">{{ section.settings.eyebrow }}</p>
        <h1 class="cbv-builder__title">{{ product.title | escape }}</h1>
        
        <div class="cbv-builder__meta">
          <div class="cbv-builder__price" data-cbv-price-display data-cbv-base-price="{{ current_variant.price }}">{{ current_variant.price | money }}</div>
          <div class="cbv-reviews-badge">
            <div class="cbv-stars">
              {%- for i in (1..5) -%}
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
              {%- endfor -%}
            </div>
            <span class="cbv-reviews-text">4.9/5 | <strong>15,000+ Poured</strong></span>
          </div>
        </div>

        {% if product.description != blank %}
          <div class="cbv-builder__description rte">{{ product.description }}</div>
        {% endif %}

        <product-form class="product-form" data-section-id="{{ section.id }}">
          <div class="product-form__error-message-wrapper" role="alert" hidden>
            <span class="product-form__error-message"></span>
          </div>

          {%- form 'product', product, id: product_form_id, class: 'form cbv-builder__form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
            <input type="hidden" name="id" value="{{ current_variant.id }}" data-cbv-variant-id>

            <!-- STEP 1: THE JAR BAR -->
            {%- if product.variants.size > 1 -%}
              <div class="cbv-builder__group cbv-jar-bar" data-cbv-step="jar">
                <div class="cbv-builder__group-header" data-cbv-accordion-toggle>
                  <label class="cbv-builder__label">
                    <span class="cbv-step-num">1</span> 
                    <span class="cbv-step-title" data-cbv-step-title="The Jar Bar">The Jar Bar</span>
                  </label>
                  <div class="cbv-builder__toggle-icon">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                  </div>
                </div>
                
                <div class="cbv-step-content">
                  <div class="cbv-jar-grid">
                    {%- for variant in product.variants -%}
                      <label class="cbv-jar-card {% if variant.id == current_variant.id %}is-selected{% endif %}" data-cbv-jar-card>
                        <input 
                          type="radio" 
                          name="cbv_jar_selection" 
                          value="{{ variant.id }}" 
                          class="visually-hidden" 
                          {% if variant.id == current_variant.id %}checked{% endif %}
                          data-cbv-jar-input
                          data-price="{{ variant.price }}"
                          data-image-src="{{ variant.featured_media | image_url: width: 1200 }}"
                          data-title="{{ variant.title }}"
                        >
                        <div class="cbv-jar-image-wrap">
                          {%- if variant.featured_media -%}
                            {{ variant.featured_media | image_url: width: 300 | image_tag: loading: 'lazy', class: 'cbv-jar-thumb' }}
                          {%- else -%}
                            {{ product.featured_media | image_url: width: 300 | image_tag: loading: 'lazy', class: 'cbv-jar-thumb' }}
                          {%- endif -%}
                        </div>
                        <div class="cbv-jar-info">
                          <span class="cbv-jar-title">{{ variant.title }}</span>
                          {% assign price_diff = variant.price | minus: product.price %}
                          {% if price_diff > 0 %}
                            <span class="cbv-jar-upgrade">+{{ price_diff | money }}</span>
                          {% else %}
                            <span class="cbv-jar-included">Included</span>
                          {% endif %}
                        </div>
                      </label>
                    {%- endfor -%}
                  </div>
                  
                  <button type="button" class="cbv-continue-btn" data-cbv-continue="wax">
                    Next: Choose Wax Color &rarr;
                  </button>
                </div>
              </div>
            {%- endif -%}

            <!-- STEP 2: WAX -->
            <div class="cbv-builder__group is-collapsed" data-cbv-step="wax">
              <div class="cbv-builder__group-header" data-cbv-accordion-toggle>
                <label class="cbv-builder__label">
                  <span class="cbv-step-num">{% if product.variants.size > 1 %}2{% else %}1{% endif %}</span> 
                  <span class="cbv-step-title" data-cbv-step-title="Choose Wax Color">Choose Wax Color</span>
                </label>
                <div class="cbv-builder__toggle-icon">
                  <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>
              </div>
              
              <div class="cbv-step-content">
                <div class="cbv-builder__wax-options" data-cbv-wax-options>
                  {%- for wax in shop.metaobjects.wax_color.values -%}
                    {%- liquid
                      assign wax_name = wax.name.value | default: wax.name
                      assign wax_active = wax.is_active.value | default: wax.is_active
                      assign wax_hex = wax.color.value | default: wax.hex_code.value | default: wax.color_hex.value | default: wax.hex.value | default: '#f5f5f5'
                    -%}
                    
                    {%- if wax_name != blank and wax_active != false -%}
                      <label class="cbv-builder__wax-item" title="{{ wax_name | escape }}">
                        <input
                          type="radio"
                          name="cbv_wax_color"
                          value="{{ wax_name | escape }}"
                          class="cbv-builder__wax-input"
                          data-cbv-wax-input
                          data-hex="{{ wax_hex }}"
                        >
                        <span
                          class="cbv-builder__wax-swatch"
                          style="--cbv-wax-color: {{ wax_hex }};"
                        ></span>
                        <span class="cbv-builder__wax-name visually-hidden">{{ wax_name }}</span>
                      </label>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
                <input type="hidden" name="properties[wax_color]" value="" data-cbv-prop-wax>
                
                <button type="button" class="cbv-continue-btn" data-cbv-continue="scent">
                  Next: Choose Scent &rarr;
                </button>
              </div>
            </div>

            <!-- STEP 3: SCENT -->
            <div class="cbv-builder__group cbv-scent is-collapsed" data-cbv-scent-picker data-cbv-step="scent">
              <div class="cbv-builder__group-header" data-cbv-accordion-toggle>
                <label class="cbv-builder__label" for="CBVScent-{{ section.id }}">
                  <span class="cbv-step-num">{% if product.variants.size > 1 %}3{% else %}2{% endif %}</span> 
                  <span class="cbv-step-title" data-cbv-step-title="Choose Scent">Choose Scent</span>
                </label>
                <div class="cbv-builder__toggle-icon">
                  <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>
              </div>
              
              <div class="cbv-step-content">
                <div class="cbv-search-wrapper">
                  <svg class="cbv-search-icon" aria-hidden="true" focusable="false" role="presentation" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                  <input
                    id="CBVScent-{{ section.id }}"
                    type="text"
                    class="cbv-builder__input"
                    placeholder="Search for a memory (e.g. Banana Nut Bread)..."
                    autocomplete="off"
                    role="combobox"
                    aria-expanded="false"
                    aria-autocomplete="list"
                    aria-controls="CBVScentResults-{{ section.id }}"
                    data-cbv-scent-input
                  >
                </div>

                <div class="cbv-scent__families" data-cbv-family-filters></div>

                <div class="cbv-scent__results-window">
                  <div id="CBVScentResults-{{ section.id }}" class="cbv-scent__results" data-cbv-results></div>
                  <p class="cbv-scent__empty" data-cbv-no-results hidden>No scents found matching your search.</p>
                </div>

                <input type="hidden" name="properties[scent_1]" value="" data-cbv-prop-scent>
                <input type="hidden" name="properties[scent_family]" value="" data-cbv-prop-family>
              </div>
            </div>

            <!-- CONFIRMATION: THE POUR TICKET -->
            <div class="cbv-pour-ticket" data-cbv-ticket hidden>
              <div class="cbv-ticket-header">Your Custom Pour</div>
              <div class="cbv-ticket-grid">
                <div class="cbv-ticket-row">
                  <span class="cbv-ticket-label">Jar Style</span>
                  <div class="cbv-ticket-value">
                    <span data-cbv-ticket-jar>{{ current_variant.title }}</span>
                  </div>
                </div>
                <div class="cbv-ticket-row">
                  <span class="cbv-ticket-label">Wax Color</span>
                  <div class="cbv-ticket-value">
                    <span class="cbv-ticket-swatch" data-cbv-ticket-swatch></span>
                    <span data-cbv-ticket-wax>--</span>
                  </div>
                </div>
                <div class="cbv-ticket-row">
                  <span class="cbv-ticket-label">Fragrance</span>
                  <div class="cbv-ticket-value">
                    <span data-cbv-ticket-scent>--</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- PURCHASE OPTIONS -->
            <div class="cbv-purchase-options" data-cbv-purchase-options>
              <label class="cbv-option-card is-selected" data-cbv-option="onetime">
                <input type="radio" name="purchase_type" value="onetime" checked class="visually-hidden">
                <div class="cbv-opt-layout">
                  <div class="cbv-opt-radio">
                    <svg class="cbv-icon-unchecked" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                    <svg class="cbv-icon-checked" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/><circle cx="12" cy="12" r="5"/></svg>
                  </div>
                  <div class="cbv-opt-content">
                    <span class="cbv-opt-title">One-Time Pour</span>
                  </div>
                  <div class="cbv-opt-price" data-cbv-onetime-price>{{ current_variant.price | money }}</div>
                </div>
              </label>

              <label class="cbv-option-card cbv-option-card--sub" data-cbv-option="sub">
                <input type="radio" name="purchase_type" value="sub" class="visually-hidden">
                <div class="cbv-opt-layout">
                  <div class="cbv-opt-radio">
                    <svg class="cbv-icon-unchecked" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                    <svg class="cbv-icon-checked" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/><circle cx="12" cy="12" r="5"/></svg>
                  </div>
                  <div class="cbv-opt-content">
                    <div class="cbv-opt-header">
                      <span class="cbv-opt-title">The Candle Club</span>
                      <span class="cbv-opt-badge">Save 10%</span>
                    </div>
                    <div class="cbv-opt-subtitle">Subscribe & save. Never run out.</div>
                  </div>
                  <div class="cbv-opt-price">
                    <span class="cbv-old-price" data-cbv-sub-old>{{ current_variant.price | money }}</span>
                    <span class="cbv-new-price" data-cbv-sub-new>{{ current_variant.price | times: 0.9 | money }}</span>
                  </div>
                </div>
              </label>

              <div class="cbv-frequency-selector" data-cbv-frequency hidden>
                <div class="cbv-freq-inner">
                  <span class="cbv-freq-label">Deliver every:</span>
                  <select name="selling_plan" class="cbv-freq-select">
                    <option value="monthly">30 Days (Most Popular)</option>
                    <option value="bimonthly">60 Days</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- ADD TO CART -->
            <div class="product-form__buttons">
              <button
                id="ProductSubmitButton-{{ section.id }}"
                type="submit"
                name="add"
                class="product-form__submit button button--primary cbv-grand-button"
                disabled
                data-cbv-submit
                data-cbv-variant-available="{{ current_variant.available }}"
              >
                <span class="cbv-btn-content">
                  <span class="cbv-btn-title">
                    {% if current_variant.available %}Pour My Candle{% else %}{{ 'products.product.sold_out' | t }}{% endif %}
                  </span>
                  <span class="cbv-btn-price" data-cbv-btn-price> - {{ current_variant.price | money }}</span>
                </span>
                
                <div class="loading-overlay-spinner hidden">
                  <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                    <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                  </svg>
                </div>
              </button>
            </div>
          {%- endform -%}
        </product-form>
      </div>
    </div>
    
    <!-- SUPPORT CONTENT -->
    <div class="cbv-content-footer">
      <div class="cbv-trust-bar-container">
        <div class="cbv-trust-bar">
          <div class="cbv-trust-item">
            <img src="https://cdn.shopify.com/s/files/1/0583/1019/7306/files/Hand-Poured-in-Texas.webp?v=1771854654" alt="Hand Poured in Texas" loading="lazy" width="80" height="80">
            <span>Hand Poured in Texas</span>
          </div>
          <div class="cbv-trust-item">
            <img src="https://cdn.shopify.com/s/files/1/0583/1019/7306/files/Premium-Wax.webp?v=1771854655" alt="Premium Wax Blend" loading="lazy" width="80" height="80">
            <span>Premium Wax Blend</span>
          </div>
          <div class="cbv-trust-item">
            <img src="https://cdn.shopify.com/s/files/1/0583/1019/7306/files/Scent-Throw.webp?v=1771854655" alt="Maximum Scent Throw" loading="lazy" width="80" height="80">
            <span>Maximum Scent Throw</span>
          </div>
          <div class="cbv-trust-item">
            <img src="https://cdn.shopify.com/s/files/1/0583/1019/7306/files/Made-to-Order.webp?v=1771854655" alt="Made to Order" loading="lazy" width="80" height="80">
            <span>Made to Order</span>
          </div>
        </div>
      </div>

      <div class="cbv-footer-split">
        <div class="cbv-footer-col cbv-footer-col--left">
          <div class="cbv-accordions">
            <details class="cbv-details" open>
              <summary class="cbv-summary">
                <span>Why Candles By Victoria?</span>
                <svg class="cbv-icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              </summary>
              <div class="cbv-details__content"><p>We don't just pour candles; we craft experiences. Every candle is double-scented for maximum "throw," ensuring your home is filled with fragrance from the first light to the last burn. Hand-poured in the USA using our proprietary safe-burning wax blend.</p></div>
            </details>
            <details class="cbv-details">
              <summary class="cbv-summary">
                <span>Shipping & Turnaround</span>
                <svg class="cbv-icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              </summary>
              <div class="cbv-details__content"><p>Because every candle is custom-made to your exact scent and color specifications, please allow 3-5 business days for creation before shipping. Good things are worth the wait!</p></div>
            </details>
            <details class="cbv-details">
              <summary class="cbv-summary">
                <span>Candle Care</span>
                <svg class="cbv-icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              </summary>
              <div class="cbv-details__content"><p>For the best burn, trim your wick to 1/4 inch before every lighting. Allow the wax pool to reach the edge of the jar during the first burn to prevent tunneling.</p></div>
            </details>
          </div>
        </div>
        <div class="cbv-footer-col cbv-footer-col--right">
          <div class="cbv-feature-card">
            {%- if section.settings.feature_image != blank -%}
              {{ section.settings.feature_image | image_url: width: 800 | image_tag: loading: 'lazy', class: 'cbv-feature-image' }}
              <div class="cbv-feature-overlay"><span class="cbv-feature-badge">The CBV Difference</span></div>
            {%- else -%}
              <div class="cbv-feature-fallback">
                <span class="cbv-feature-icon">âœ¨</span>
                <h3>The CBV Promise</h3>
                <p>Every jar is poured by hand in Texas, double-scented, and cured to perfection. Experience the difference of true craftsmanship.</p>
                <div class="cbv-signature">Victoria</div>
              </div>
            {%- endif -%}
          </div>
        </div>
      </div>
    </div>
  </div>

  {%- paginate shop.metaobjects.fragrance.values by 250 -%}
    <script
      type="application/json"
      data-cbv-fragrance-data
      data-cbv-fragrance-page="{{ paginate.current_page }}"
      data-cbv-fragrance-pages="{{ paginate.pages }}"
      data-cbv-fragrance-page-param="{{ paginate.page_param }}"
    >
      [
        {%- assign first_entry = true -%}
        {%- for fragrance in shop.metaobjects.fragrance.values -%}
          {%- liquid
            assign scent_name = fragrance.name.value | default: fragrance.name
            assign scent_family = fragrance.scent_family.value | default: fragrance.scent_family
            assign scent_active = fragrance.is_active.value | default: fragrance.is_active
          -%}
          {%- if scent_name != blank and scent_active != false -%}
            {%- unless first_entry -%},{%- endunless -%}
            {
              "name": {{ scent_name | json }},
              "family": {{ scent_family | default: 'Uncategorized' | json }},
              "handle": {{ fragrance.handle | json }}
            }
            {%- assign first_entry = false -%}
          {%- endif -%}
        {%- endfor -%}
      ]
    </script>
  {%- endpaginate -%}
</section>

{% schema %}
{
  "name": "CBV Builder product",
  "settings": [
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow",
      "default": "Customize your candle"
    },
    {
      "type": "image_picker",
      "id": "feature_image",
      "label": "Footer Feature Image",
      "info": "Appears to the right of the FAQs. Portrait or Square recommended."
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "option-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 32
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "CBV Builder product"
    }
  ]
}
{% endschema %}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}