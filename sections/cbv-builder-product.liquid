{{ 'section-cbv-builder-product.css' | asset_url | stylesheet_tag }}
<script src="{{ 'cbv-builder-product.js' | asset_url }}" defer="defer"></script>

{%- liquid
  assign product_form_id = 'cbv-builder-product-form-' | append: section.id
  assign variant = product.selected_or_first_available_variant
-%}

<section class="cbv-builder color-{{ section.settings.color_scheme }} gradient" data-cbv-builder data-section-id="{{ section.id }}">
  <div class="page-width section-{{ section.id }}-padding">
    <div class="cbv-builder__grid">
      
      <!-- Media Column -->
      <div class="cbv-builder__media">
        {% if product.featured_media %}
          <div class="cbv-builder__image-wrapper" style="--ratio-percent: {{ 1 | divided_by: product.featured_media.aspect_ratio | times: 100 }}%;">
            {{
              product.featured_media
              | image_url: width: 1200
              | image_tag:
                loading: 'lazy',
                widths: '400, 600, 900, 1200',
                sizes: '(min-width: 990px) 50vw, 100vw',
                class: 'cbv-builder__image'
            }}
          </div>
        {% endif %}
      </div>

      <!-- Content Column -->
      <div class="cbv-builder__content">
        <p class="cbv-builder__eyebrow">{{ section.settings.eyebrow }}</p>
        <h1 class="cbv-builder__title">{{ product.title | escape }}</h1>
        <div class="cbv-builder__price">{% render 'price', product: product, use_variant: true, show_badges: true, price_class: 'price--large' %}</div>
        {% if product.description != blank %}
          <div class="cbv-builder__description rte">{{ product.description }}</div>
        {% endif %}

        <product-form class="product-form" data-section-id="{{ section.id }}">
          <div class="product-form__error-message-wrapper" role="alert" hidden>
            <span class="product-form__error-message"></span>
          </div>

          {%- form 'product', product, id: product_form_id, class: 'form cbv-builder__form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
            <input type="hidden" name="id" value="{{ variant.id }}" class="product-variant-id" {% unless variant.available %}disabled{% endunless %}>

            <!-- STEP 1: WAX -->
            <div class="cbv-builder__group">
              <label class="cbv-builder__label">1. Choose wax color <span class="cbv-builder__selection" data-cbv-wax-selection></span></label>
              
              <div class="cbv-builder__wax-options" data-cbv-wax-options>
                {%- for wax in shop.metaobjects.wax_color.values -%}
                  {%- liquid
                    assign wax_name = wax.name.value | default: wax.name
                    assign wax_active = wax.is_active.value | default: wax.is_active
                    assign wax_hex = wax.color.value | default: wax.hex_code.value | default: wax.color_hex.value | default: wax.hex.value | default: '#f5f5f5'
                  -%}
                  
                  {%- if wax_name != blank and wax_active != false -%}
                    <label class="cbv-builder__wax-item" title="{{ wax_name | escape }}">
                      <input
                        type="radio"
                        name="cbv_wax_color"
                        value="{{ wax_name | escape }}"
                        class="cbv-builder__wax-input"
                        data-cbv-wax-input
                      >
                      <span
                        class="cbv-builder__wax-swatch"
                        style="--cbv-wax-color: {{ wax_hex }};"
                      ></span>
                      <span class="visually-hidden">{{ wax_name }}</span>
                    </label>
                  {%- endif -%}
                {%- endfor -%}
              </div>
              
              <input type="hidden" name="properties[wax_color]" value="" data-cbv-prop-wax>
            </div>

            <!-- STEP 2: SCENT -->
            <div class="cbv-builder__group cbv-scent" data-cbv-scent-picker>
              <label class="cbv-builder__label" for="CBVScent-{{ section.id }}">2. Choose scent <span class="cbv-builder__selection" data-cbv-scent-selection></span></label>
              
              <!-- Search -->
              <div class="cbv-search-wrapper">
                <svg class="cbv-search-icon" aria-hidden="true" focusable="false" role="presentation" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input
                  id="CBVScent-{{ section.id }}"
                  type="text"
                  class="cbv-builder__input"
                  placeholder="Search 800+ fragrances..."
                  autocomplete="off"
                  role="combobox"
                  aria-expanded="false"
                  aria-autocomplete="list"
                  aria-controls="CBVScentResults-{{ section.id }}"
                  data-cbv-scent-input
                >
              </div>

              <!-- Categories (NOW WRAPPED, NOT SCROLLING) -->
              <div class="cbv-scent__families" data-cbv-family-filters></div>

              <!-- Results Window -->
              <div class="cbv-scent__results-window">
                <div id="CBVScentResults-{{ section.id }}" class="cbv-scent__results" data-cbv-results></div>
                <p class="cbv-scent__empty" data-cbv-no-results hidden>No scents found matching your search.</p>
              </div>

              <input type="hidden" name="properties[scent_1]" value="" data-cbv-prop-scent>
              <input type="hidden" name="properties[scent_family]" value="" data-cbv-prop-family>
            </div>

            <!-- Status & Button -->
            <p class="cbv-builder__helper" data-cbv-helper>Choose a wax color and scent to continue.</p>

            <div class="product-form__buttons">
              <button
                id="ProductSubmitButton-{{ section.id }}"
                type="submit"
                name="add"
                class="product-form__submit button button--primary"
                disabled
                data-cbv-submit
                data-cbv-variant-available="{{ variant.available }}"
              >
                <span>{% if variant.available %}{{ 'products.product.add_to_cart' | t }}{% else %}{{ 'products.product.sold_out' | t }}{% endif %}</span>
                <div class="loading-overlay-spinner hidden">
                  <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                    <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                  </svg>
                </div>
              </button>
            </div>
          {%- endform -%}
        </product-form>
      </div>
    </div>
  </div>

  {%- paginate shop.metaobjects.fragrance.values by 250 -%}
    <script
      type="application/json"
      data-cbv-fragrance-data
      data-cbv-fragrance-page="{{ paginate.current_page }}"
      data-cbv-fragrance-pages="{{ paginate.pages }}"
      data-cbv-fragrance-page-param="{{ paginate.page_param }}"
    >
      [
        {%- assign first_entry = true -%}
        {%- for fragrance in shop.metaobjects.fragrance.values -%}
          {%- liquid
            assign scent_name = fragrance.name.value | default: fragrance.name
            assign scent_family = fragrance.scent_family.value | default: fragrance.scent_family
            assign scent_active = fragrance.is_active.value | default: fragrance.is_active
          -%}
          {%- if scent_name != blank and scent_active != false -%}
            {%- unless first_entry -%},{%- endunless -%}
            {
              "name": {{ scent_name | json }},
              "family": {{ scent_family | default: 'Uncategorized' | json }},
              "handle": {{ fragrance.handle | json }}
            }
            {%- assign first_entry = false -%}
          {%- endif -%}
        {%- endfor -%}
      ]
    </script>
  {%- endpaginate -%}
</section>

{% schema %}
{
  "name": "CBV Builder product",
  "settings": [
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow",
      "default": "Customize your candle"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "option-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 32
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "CBV Builder product"
    }
  ]
}
{% endschema %}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}